use crate::orderbook::{
    Level,
    Operation,
    Source,
};
use futures_util::{
    SinkExt,
    StreamExt,
};
use opentelemetry::{
    global,
    sdk::trace as sdktrace,
    trace::{
        FutureExt,
        TraceContextExt,
        Tracer,
        TraceError,
    },
    Context,
};
use serde_derive::{
    Deserialize,
    Serialize,
};
use std::num::ParseFloatError;
use tokio::{
    io::AsyncWriteExt,
    sync::mpsc::UnboundedSender,
};
use tokio_tungstenite::{
    connect_async,
    tungstenite::Message,
};
use url::Url;


#[derive(Serialize, Deserialize)]
struct OrderbookData {
    asks: Vec<Vec<String>>,
    bids: Vec<Vec<String>>,
}

#[derive(Debug)]
pub enum OKXError {
    AskPriceParse(ParseFloatError),
    AskSizeParse(ParseFloatError),
    BidPriceParse(ParseFloatError),
    BidSizeParse(ParseFloatError),
    UrlParse(url::ParseError),
    WSConnect(tokio_tungstenite::tungstenite::Error),
    WSSend(tokio_tungstenite::tungstenite::Error),
}

impl OrderbookData {
    fn asks_level(&self) -> Result<Vec<Level>, OKXError> {
        let mut resp = Vec::with_capacity(self.asks.len());
        for ask in &self.asks {
            resp.push(Level {
                price: ask[0].parse::<f64>().map_err(OKXError::AskPriceParse)?,
                size: ask[1].parse::<f64>().map_err(OKXError::AskSizeParse)?,
            });
        }
        Ok(resp)
    }

    fn bids_level(&self) -> Result<Vec<Level>, OKXError> {
        let mut resp = Vec::with_capacity(self.bids.len());
        for bid in &self.bids {
            resp.push(Level {
                price: bid[0].parse::<f64>().map_err(OKXError::BidPriceParse)?,
                size: bid[1].parse::<f64>().map_err(OKXError::BidSizeParse)?,
            });
        }
        Ok(resp)
    }
}

#[derive(Serialize, Deserialize)]
#[serde(tag = "action")]
enum OrderbookResponse {
    #[serde(rename = "snapshot")]
    Snapshot { data: Vec<OrderbookData> },
    #[serde(rename = "update")]
    Update { data: Vec<OrderbookData> },
}

impl TryInto<Operation> for OrderbookResponse {
    type Error = OKXError;

    fn try_into(self) -> Result<Operation, Self::Error> {
        match self {
            OrderbookResponse::Snapshot { data } => {
                Ok(Operation::Snapshot {
                    asks: data[0].asks_level()?,
                    bids: data[0].bids_level()?,
                    source: Source::OKX,
                })
            }
            OrderbookResponse::Update { data } => {
                Ok(Operation::Update {
                    asks: data[0].asks_level()?,
                    bids: data[0].bids_level()?,
                    source: Source::OKX,
                })
            }
        }
    }
}

#[derive(Serialize, Deserialize)]
#[serde(untagged)]
enum WebsocketResponse {
    Action(OrderbookResponse),
    Response { event: String },
}

pub async fn consume_orderbook(sender: UnboundedSender<Operation>) -> Result<(), OKXError> {
    let tracer = global::tracer("orderbook_okx_processor");
    let span = tracer.start("orderbook_okx");
    let cx = Context::current_with_span(span);

    let connect_addr = "wss://ws.okx.com:8443/ws/v5/public".to_string();
    let url = Url::parse(&connect_addr).map_err(OKXError::UrlParse)?;

    let (ws_stream, _) = connect_async(url).
        with_context(cx.clone()).await.
        map_err(OKXError::WSConnect)?;
    println!("WebSocket handshake has been successfully completed");

    let (mut write, read) = ws_stream.split();
    write.send(Message::Text(
        r#"{"op":"subscribe","args":[{"channel": "books","instId":"BTC-USD-SWAP"}]}"#.to_string())
    ).with_context(cx.clone()).await.map_err(OKXError::WSSend)?;

    read.for_each(|message| async {
        let span = tracer.start("orderbook_okx_msg");
        let cx = Context::current_with_span(span);

        let okx_parse: serde_json::Result<WebsocketResponse> = serde_json::from_slice(
            &message.unwrap().into_data(),
        );
        match okx_parse {
            Ok(resp) => {
                match resp {
                    WebsocketResponse::Action(action) => {
                        sender.send(action.try_into().ok().unwrap()).ok().unwrap();
                    }
                    WebsocketResponse::Response { event } => {
                        tokio::io::stdout().write_all(
                            format!("Got event {:?}\n", event).as_bytes(),
                        ).with_context(cx.clone()).await.unwrap();
                    }
                }
            }
            Err(err) => {
                tokio::io::stdout().write_all(
                    format!("Got parse error {:?}\n", err).as_bytes(),
                ).with_context(cx.clone()).await.unwrap();
            }
        }
    }).with_context(cx.clone()).await;

    Ok(())
}

mod test {
    use crate::okx::{
        OrderbookData,
        OrderbookResponse,
        WebsocketResponse,
    };

    #[test]
    fn should_parse_a_subscribe() {
        // Given
        let msg = r#"{"event":"subscribe","arg":{"channel":"books","instId":"BTC-USDT"}}"#;

        // When
        let resp: WebsocketResponse = serde_json::from_str(msg).unwrap();

        // Then
        if let WebsocketResponse::Response { event } = resp {
            assert_eq!("subscribe", event);
        } else {
            assert!(false, "not a subscribe");
        }
    }

    #[test]
    fn should_serialize_an_update() {
        // Given
        let resp = WebsocketResponse::Action(OrderbookResponse::Update {
            data: vec![
                OrderbookData {
                    asks: vec![
                        vec!["23811.9".to_string(), "0.23617".to_string(), "0".to_string(), "2".to_string()],
                    ],
                    bids: vec![],
                },
            ],
        });

        // When
        let serialized = serde_json::to_string(&resp);

        // Then
        let msg = r#"{"action":"update","data":[{"asks":[["23811.9","0.23617","0","2"]],"bids":[]}]}"#.to_string();
        if let Ok(ser_msg) = serialized {
            assert_eq!(msg, ser_msg);
        } else {
            assert!(false, "serialization issue");
        }
    }

    //{"arg":{"channel":"books","instId":"BTC-USDT"},"action":"snapshot","data":[{"asks":[["23811","0.40912731","0","5"],["23811.9","0.24513315","0","3"],["23812.4","0.02","0","1"],["23812.8","0.04199805","0","1"],["23812.9","0.2095","0","1"],["23813","0.55","0","1"],["23813.1","1.16731842","0","5"],["23813.2","0.11275","0","1"],["23813.9","0.0003","0","1"],["23815","0.001","0","1"],["23815.4","0.00717","0","1"],["23815.5","0.178","0","1"],["23815.9","0.04809","0","2"],["23816","0.001","0","1"],["23816.2","0.06819","0","1"],["23816.6","0.00717","0","1"],["23816.9","0.01096112","0","1"],["23817","0.04616448","0","2"],["23817.1","0.20991242","0","1"],["23817.3","0.1905","0","1"],["23817.4","1.38967291","0","3"],["23817.7","1.1","0","1"],["23817.8","0.00717","0","1"],["23817.9","0.03611","0","1"],["23818","0.179","0","2"],["23818.1","0.03732","0","2"],["23818.2","0.0682","0","1"],["23819","0.00817","0","2"],["23819.5","0.56978143","0","2"],["23819.7","0.0682","0","1"],["23820","0.00996258","0","1"],["23820.2","0.00717","0","1"],["23820.8","0.0404439","0","1"],["23820.9","0.22471303","0","3"],["23821.3","0.29389","0","1"],["23821.4","0.00717","0","1"],["23822","0.0682","0","1"],["23822.6","0.00129356","0","1"],["23822.7","0.2115","0","2"],["23822.9","0.0682","0","1"],["23823.1","0.013147","0","1"],["23823.5","1.27159487","0","3"],["23823.6","2.366","0","1"],["23823.8","0.00717","0","1"],["23824","0.41931","0","1"],["23824.1","0.0682","0","1"],["23824.2","0.38067531","0","1"],["23824.9","0.00717","0","1"],["23825.2","0.00989172","0","1"],["23825.3","0.0682","0","1"],["23825.4","0.178","0","1"],["23826.1","0.00717","0","1"],["23826.8","0.084","0","1"],["23827","0.09047422","0","2"],["23827.3","0.00717","0","1"],["23827.4","0.0678","0","1"],["23827.7","0.03144288","0","1"],["23827.9","2.45001","0","2"],["23828","0.08766307","0","1"],["23828.5","5.31850191","0","2"],["23828.6","0.62943231","0","1"],["23829.1","0.06602","0","1"],["23829.5","0.04846913","0","1"],["23829.7","0.18517","0","2"],["23829.9","0.54526602","0","2"],["23830","1.20001975","0","2"],["23830.2","0.06602","0","1"],["23830.3","0.05","0","1"],["23830.4","0.672168","0","1"],["23830.8","0.00765892","0","1"],["23830.9","0.6365416","0","2"],["23831.1","0.04","0","1"],["23831.4","0.06602","0","1"],["23832.1","0.07331","0","2"],["23832.2","0.178","0","1"],["23832.3","0.033","0","1"],["23832.6","0.85227563","0","2"],["23832.7","0.04846262","0","1"],["23832.8","0.06629","0","1"],["23833.2","0.82806378","0","2"],["23833.3","0.00717","0","1"],["23833.7","0.1","0","1"],["23833.8","0.05139763","0","1"],["23833.9","0.04822","0","1"],["23834","0.01804","0","1"],["23834.4","0.75219547","0","1"],["23834.5","0.05539","0","2"],["23834.6","0.178","0","1"],["23835.2","0.41129","0","2"],["23835.5","0.1","0","1"],["23835.7","0.00717","0","1"],["23836","0.1","0","1"],["23836.4","0.0761741","0","2"],["23836.9","0.00717","0","1"],["23837","0.178","0","1"],["23837.1","0.15","0","1"],["23837.6","0.86542234","0","3"],["23838.1","0.00423009","0","1"],["23838.5","0.04545129","0","1"],["23838.8","0.06623","0","1"],["23839.2","0.00717","0","1"],["23839.3","0.00005872","0","1"],["23839.6","1.11922","0","2"],["23839.7","5.36558842","0","1"],["23839.9","0.06614","0","1"],["23840.3","0.15994626","0","1"],["23840.4","0.00717","0","1"],["23840.7","0.20614","0","2"],["23840.8","0.24","0","1"],["23840.9","0.178","0","1"],["23841.4","0.06774","0","1"],["23841.5","0.18","0","1"],["23841.6","0.00717","0","1"],["23842.1","0.354178","0","1"],["23842.2","1.8317","0","1"],["23842.4","0.06614","0","1"],["23842.5","0.24","0","1"],["23842.8","0.00717","0","1"],["23843.3","0.178","0","1"],["23843.4","0.0682","0","1"],["23843.5","0.60768467","0","1"],["23843.9","0.00964344","0","1"],["23844","0.12806976","0","2"],["23844.2","0.31","0","1"],["23844.3","0.62901794","0","1"],["23844.6","0.0682","0","1"],["23845","1.263","0","1"],["23845.2","0.00717","0","1"],["23845.5","0.116","0","1"],["23845.6","2.43499","0","1"],["23845.8","0.178","0","1"],["23846.2","0.0682","0","1"],["23846.4","0.21701773","0","2"],["23847.3","0.00001001","0","1"],["23847.4","0.0682","0","1"],["23847.6","0.00717","0","1"],["23847.8","0.24","0","1"],["23847.9","0.15","0","1"],["23848.3","0.12","0","1"],["23848.6","0.00964202","0","1"],["23848.8","0.00717","0","1"],["23849.7","0.278","0","2"],["23850","0.19717043","0","2"],["23851.2","0.00717","0","1"],["23851.8","0.03609538","0","1"],["23851.9","0.05","0","1"],["23852.1","0.178","0","1"],["23852.4","0.00717","0","1"],["23853.6","0.04916687","0","2"],["23853.7","0.01338674","0","2"],["23854.1","3.1295","0","1"],["23854.2","0.00231404","0","1"],["23854.7","0.00717","0","1"],["23855","2.92227774","0","2"],["23855.8","1.22919974","0","1"],["23855.9","0.00717","0","1"],["23856","0.55611705","0","3"],["23857.1","0.00762351","0","2"],["23858.3","0.00717","0","1"],["23858.7","0.178","0","1"],["23858.8","0.62863297","0","1"],["23858.9","1","0","1"],["23859.5","0.00717","0","1"],["23860.7","0.00717","0","1"],["23860.8","0.03958565","0","1"],["23860.9","1.180594","0","1"],["23861","4.59798","0","2"],["23861.5","4.86739","0","1"],["23861.9","0.00717","0","1"],["23862","0.62855061","0","1"],["23862.5","0.00088108","0","1"],["23862.6","1.175","0","1"],["23863.1","0.00717","0","1"],["23864.1","4.985","0","1"],["23864.2","0.001773","0","1"],["23864.3","0.00717","0","1"],["23865.4","0.052","0","1"],["23865.5","0.00717","0","1"],["23865.6","0.04509587","0","1"],["23865.9","0.00225495","0","1"],["23866.6","4.86758479","0","6"],["23866.7","0.00717","0","1"],["23866.9","0.01432378","0","1"],["23867.9","0.00717","0","1"],["23868","0.16802557","0","1"],["23868.1","0.341113","0","1"],["23869.1","0.00717","0","1"],["23870.3","0.00717","0","1"],["23871.5","0.00717","0","1"],["23872.5","0.01694764","0","1"],["23872.6","0.00717","0","1"],["23872.7","0.00001286","0","1"],["23873.3","0.00002749","0","1"],["23873.8","0.00717","0","1"],["23875","0.00717","0","1"],["23875.2","4.20557171","0","2"],["23875.8","0.000189","0","1"],["23876.2","0.02103449","0","3"],["23876.8","0.00003136","0","1"],["23877.3","0.00672756","0","1"],["23877.4","0.00717","0","1"],["23877.6","0.20541417","0","2"],["23878.6","0.00717","0","1"],["23879.8","0.00717","0","1"],["23879.9","0.0001053","0","2"],["23880","0.00043751","0","2"],["23881","0.00717","0","1"],["23882.2","0.00718085","0","2"],["23882.3","3.541783","0","1"],["23882.4","4.62008","0","2"],["23882.6","2.1130192","0","1"],["23883","1","0","1"],["23883.4","0.00717","0","1"],["23883.5","0.00080182","0","1"],["23884.6","0.00717","0","1"],["23885.8","0.00717","0","1"],["23885.9","0.00002834","0","1"],["23887","0.00717","0","1"],["23887.6","0.00072017","0","1"],["23888.2","0.00717","0","1"],["23889.4","0.00717","0","1"],["23890","0.00009868","0","1"],["23890.6","0.00717","0","1"],["23891.1","0.00003542","0","1"],["23891.3","0.00001001","0","1"],["23891.6","2.45839948","0","1"],["23891.8","0.00717","0","1"],["23892.9","0.00717","0","1"],["23894.1","0.00717","0","1"],["23894.5","0.00001065","0","1"],["23894.7","0.00002205","0","1"],["23895.3","0.00717","0","1"],["23896.5","0.00717","0","1"],["23896.6","0.00148701","0","1"],["23897.7","0.00746217","0","2"],["23898.9","0.00717","0","1"],["23899.7","0.00023854","0","1"],["23900","0.09733122","0","17"],["23900.1","0.00717","0","1"],["23901.3","0.00717","0","1"],["23901.5","0.00003238","0","1"],["23902.5","0.00717","0","1"],["23903.7","0.00717","0","1"],["23904","2.11478558","0","2"],["23904.1","0.03337938","0","1"],["23904.4","0.01338674","0","2"],["23904.9","0.00717","0","1"],["23905","5.902973","0","1"],["23905.9","0.00049936","0","1"],["23906.1","0.00717","0","1"],["23906.2","10.9296","0","1"],["23907.1","0.00231404","0","1"],["23907.3","0.00717","0","1"],["23907.6","0.03646632","0","6"],["23908.5","0.00717","0","1"],["23909.2","0.00028048","0","1"],["23909.7","0.00717","0","1"],["23909.9","0.00259393","0","1"],["23910","0.01106031","0","1"],["23910.1","0.00077431","0","1"],["23910.8","0.00059686","0","1"],["23910.9","0.00396318","0","1"],["23911","0.00001042","0","1"],["23912.1","0.00717","0","1"],["23912.6","0.00008707","0","1"],["23913","0.00048723","0","1"],["23913.3","0.00717","0","1"],["23914.2","0.00045351","0","1"],["23914.5","0.00717","0","1"],["23915","0.00100631","0","1"],["23915.6","0.00020907","0","1"],["23915.7","0.00717","0","1"],["23916.6","0.00029341","0","2"],["23916.8","0.00717","0","1"],["23917.3","0.00020786","0","1"],["23917.9","4.14","0","1"],["23918","0.00717","0","1"],["23919.2","0.00717","0","1"],["23919.8","0.00010011","0","1"],["23920","0.00108961","0","4"],["23920.4","0.00717","0","1"],["23921.6","0.00717","0","1"],["23922.8","0.00717","0","1"],["23923","0.00005734","0","1"],["23923.7","0.00003496","0","1"],["23924","0.00717","0","1"],["23924.8","0.00027174","0","1"],["23925","0.00088108","0","1"],["23925.2","0.00717","0","1"],["23925.4","2.10045034","0","1"],["23926.4","0.00717","0","1"],["23926.6","0.00031045","0","1"],["23927.2","0.00027471","0","1"],["23927.6","0.00717","0","1"],["23927.7","4.9233","0","1"],["23928.5","0.0003118","0","2"],["23928.6","0.01386449","0","2"],["23928.7","0.0005621","0","1"],["23928.8","0.00717","0","1"],["23929","0.00014016","0","1"],["23929.9","0.0000326","0","1"],["23930","0.00718079","0","2"],["23930.1","0.00003208","0","1"],["23931.2","0.00723937","0","2"],["23932.2","0.14138462","0","1"],["23932.4","0.00717","0","1"],["23932.6","0.00225495","0","1"],["23933","0.33627216","0","2"],["23933.3","0.00098239","0","9"],["23933.6","0.00897436","0","3"],["23934.2","0.00036729","0","2"],["23934.8","0.00717","0","1"],["23936","0.00739448","0","2"],["23936.7","0.06","0","1"],["23936.9","0.00001085","0","1"],["23937.2","0.00717","0","1"],["23937.5","0.00002055","0","1"],["23938.4","0.00717","0","1"],["23939.6","0.00717","0","1"],["23940","0.00078064","0","4"],["23940.1","0.00001286","0","1"],["23940.8","0.00717","0","1"],["23942","0.00717","0","1"],["23943.2","0.00717","0","1"],["23944.4","0.00717","0","1"],["23944.7","0.00002923","0","1"],["23945","0.00050246","0","1"],["23945.6","0.00717","0","1"],["23946.6","0.00002749","0","1"],["23946.8","0.00717","0","1"],["23947.1","0.00194152","0","1"],["23947.3","0.00002205","0","1"],["23948","0.00717","0","1"],["23949.2","0.00717","0","1"],["23949.5","13.48921774","0","2"],["23950","0.00381919","0","5"],["23950.4","0.00717","0","1"],["23951.1","0.00001065","0","1"],["23951.6","0.00717","0","1"],["23952","0.69276857","0","3"],["23952.3","0.00005733","0","1"],["23952.8","0.00717","0","1"],["23953.2","0.00080182","0","1"],["23953.9","0.00717","0","1"],["23954.5","0.04636184","0","2"],["23955.1","0.00717","0","1"],["23955.2","0.01338674","0","2"],["23956.3","0.00717","0","1"],["23956.4","0.0000953","0","1"],["23956.5","0.00007614","0","2"],["23957.5","0.00717","0","1"],["23958","0.00052533","0","1"],["23958.7","0.00717","0","1"],["23959.9","0.00948404","0","2"],["23960","0.00009868","0","1"],["23960.5","0.00001","0","1"],["23960.9","0.00072017","0","1"],["23961.1","0.00717","0","1"],["23961.5","0.00003542","0","1"],["23962.3","0.00717","0","1"],["23963.5","0.00717","0","1"],["23964.7","0.00717","0","1"],["23965.3","0.00048861","0","1"],["23965.9","0.00717","0","1"],["23966","0.00003436","0","1"],["23966.1","0.00025007","0","1"],["23966.6","0.00163561","0","2"],["23967.1","0.00717","0","1"],["23968.3","0.00729844","0","2"],["23969.5","0.00717","0","1"],["23969.7","0.00050625","0","1"],["23970","0.00146866","0","2"],["23970.5","0.00001052","0","1"],["23970.7","0.00717","0","1"],["23971.1","0.023","0","1"],["23971.4","0.00045351","0","1"],["23971.9","0.00717","0","1"],["23972.3","0.03646632","0","6"],["23973.1","0.00717","0","1"],["23973.3","0.0006929","0","1"],["23974.2","0.00004432","0","1"],["23974.3","0.00717","0","1"],["23974.6","0.00010169","0","1"],["23974.7","1.2128","0","1"],["23975.5","0.00717","0","1"],["23976.7","0.00179309","0","2"],["23977.6","0.00155819","0","1"],["23977.8","0.00077431","0","1"],["23977.9","0.00717","0","1"],["23979","0.00004357","0","2"],["23979.1","0.00725707","0","2"],["23980.3","0.00717","0","1"],["23980.9","0.0000887","0","1"],["23981","0.01386449","0","2"],["23981.5","0.00717","0","1"],["23982.6","0.00002834","0","1"],["23982.7","0.00717","0","1"],["23983.6","0.41928721","0","1"],["23983.7","0.00028035","0","1"],["23983.9","0.00717","0","1"]],"bids":[["23810.9","0.24088112","0","2"],["23810.8","0.00005517","0","1"],["23810.7","0.00717","0","1"],["23809.9","0.8193","0","2"],["23809.5","0.00717","0","1"],["23809.3","0.41995972","0","1"],["23808.5","0.06832","0","2"],["23808.3","0.04916","0","2"],["23807.8","0.11275","0","1"],["23807.1","0.00717","0","1"],["23806.3","0.084","0","2"],["23805.9","0.00717","0","1"],["23805.7","0.04199805","0","1"],["23805.6","0.63003827","0","1"],["23804.9","0.00101831","0","2"],["23804.7","0.00717","0","1"],["23803.5","0.00333786","0","1"],["23803.1","0.013147","0","1"],["23802.8","0.06811","0","1"],["23802.6","0.29389","0","1"],["23802.3","0.63142665","0","2"],["23801.9","0.01146644","0","1"],["23801.8","0.0990794","0","2"],["23801.2","0.042","0","1"],["23801.1","0.18517","0","2"],["23800.7","0.01101848","0","1"],["23800.5","0.06794","0","1"],["23800.1","0.32","0","1"],["23800","0.39971479","0","1"],["23799.9","0.00717","0","1"],["23799.5","0.06460422","0","2"],["23799.3","0.06792","0","1"],["23798.9","0.00982195","0","1"],["23798.8","0.70929448","0","3"],["23798.7","0.80822023","0","2"],["23798.1","0.07363293","0","2"],["23798","2.415","0","1"],["23797.7","0.75436273","0","1"],["23797.6","0.00717","0","1"],["23797.5","0.41931","0","1"],["23796.9","0.06779","0","1"],["23796.8","0.7355","0","2"],["23796.7","1.2","0","1"],["23796.4","0.00717","0","1"],["23796.3","0.178","0","1"],["23796.2","0.06811","0","1"],["23795.6","0.75492272","0","1"],["23795.5","0.0679","0","1"],["23795.2","0.00132373","0","1"],["23794.6","0.06775","0","1"],["23794.1","0.75522363","0","1"],["23794","0.00717","0","1"],["23793.8","0.06775","0","1"],["23793.7","0.01028072","0","1"],["23792.8","0.18517","0","2"],["23792.6","0.03227017","0","1"],["23792.4","0.04199845","0","1"],["23792.2","0.06819","0","1"],["23791.9","0.05","0","1"],["23791.6","0.00717","0","1"],["23791.3","0.63041001","0","1"],["23791","0.06819","0","1"],["23790.5","0.672175","0","1"],["23790.4","0.18517","0","2"],["23790.2","4.991","0","1"],["23790.1","0.00001682","0","1"],["23790","0.00016059","0","3"],["23789.7","0.15","0","1"],["23789.4","0.00002207","0","1"],["23789.2","0.00717","0","1"],["23789.1","0.02506671","0","2"],["23788.9","0.0001","0","1"],["23788.7","0.00990785","0","1"],["23788.6","0.0335","0","1"],["23788.4","0.03550844","0","1"],["23788.3","0.00003267","0","1"],["23788.1","0.01217","0","2"],["23788","0.17889366","0","2"],["23787.4","0.00271751","0","1"],["23787.2","0.00012607","0","1"],["23786.9","0.0075961","0","2"],["23786.7","0.63053855","0","1"],["23786.6","0.00005432","0","1"],["23786.3","0.02548632","0","1"],["23785.7","0.00748783","0","3"],["23785.6","0.26565838","0","2"],["23785.4","0.052","0","1"],["23784.7","1","0","1"],["23784.5","0.00717","0","1"],["23784.2","0.02756672","0","1"],["23784.1","0.12598048","0","3"],["23784","0.0005","0","1"],["23783.9","0.04451913","0","2"],["23783.3","0.00745727","0","2"],["23782.6","0.00001013","0","1"],["23782.5","0.00002936","0","1"],["23782.3","0.12599033","0","1"],["23782.1","0.00717","0","1"],["23781.7","0.17827493","0","2"],["23781.4","0.00001066","0","1"],["23780.9","0.00717","0","1"],["23780.5","1.22919974","0","1"],["23780.1","0.00003439","0","1"],["23780","0.00043562","0","3"],["23779.7","0.00717","0","1"],["23779.4","0.002","0","1"],["23779.2","0.0392728","0","1"],["23778.9","0.00013518","0","2"],["23778.8","0.00133076","0","1"],["23778.7","0.03648929","0","6"],["23778.5","0.00717","0","1"],["23778.3","0.00002538","0","1"],["23777.7","0.17829037","0","3"],["23777.6","3.287","0","1"],["23777.3","0.00717","0","1"],["23776.6","0.00025967","0","1"],["23776.2","0.00717","0","1"],["23775.6","0.00006262","0","1"],["23775.5","0.06","0","1"],["23775.4","0.41506","0","1"],["23775","0.63863496","0","4"],["23774.9","0.178","0","1"],["23774.8","0.00077493","0","1"],["23774.2","0.48614774","0","1"],["23773.8","0.64465295","0","3"],["23773.3","0.00010537","0","2"],["23772.8","1.263","0","1"],["23772.7","0.00001086","0","1"],["23772.6","0.00738033","0","2"],["23772.5","1","0","1"],["23772.4","0.0001002","0","1"],["23772.3","0.64280055","0","3"],["23772.2","0.178","0","1"],["23771.9","0.01386449","0","2"],["23771.5","0.01436689","0","1"],["23771.4","0.00717","0","1"],["23770.7","0.00561417","0","1"],["23770.2","0.00717","0","1"],["23769.2","0.0000677","0","2"],["23769","0.0871061","0","2"],["23768.7","0.052","0","1"],["23768.6","0.201","0","2"],["23767.9","0.00002034","0","1"],["23767.8","0.00719406","0","2"],["23767.7","0.04645499","0","1"],["23767.4","4.86646","0","1"],["23767.1","0.00414705","0","1"],["23766.7","0.00717","0","1"],["23766.6","0.16","0","1"],["23766.4","0.00018227","0","1"],["23765.9","0.31006109","0","2"],["23765.7","0.04","0","1"],["23765.5","0.00717","0","1"],["23765.1","0.178","0","1"],["23764.9","0.00012855","0","1"],["23764.3","0.00717","0","1"],["23763.9","4.86595","0","1"],["23763.7","1.175","0","1"],["23763.5","0.0011","0","1"],["23763.4","0.00965208","0","1"],["23763.2","0.00028058","0","1"],["23763.1","0.00720139","0","2"],["23763","0.00073757","0","1"],["23762.6","0.00006515","0","1"],["23761.9","0.00719218","0","2"],["23761.5","0.178","0","1"],["23761.1","0.24","0","1"],["23760.8","0.00001002","0","1"],["23760.7","0.00717","0","1"],["23760.5","0.00001","0","1"],["23760","0.01169806","0","13"],["23759.9","0.42021102","0","3"],["23759.6","4.26497","0","2"],["23759.5","0.24717","0","2"],["23759.1","0.00037816","0","1"],["23758.7","0.6409257","0","2"],["23758.5","0.24","0","1"],["23758.3","0.32717","0","2"],["23758","0.00027359","0","1"],["23757.3","2.61419","0","2"],["23757.2","0.00021046","0","1"],["23757.1","0.00750923","0","2"],["23756.1","1","0","1"],["23756","0.00717","0","1"],["23755.5","0.18007185","0","1"],["23755","1.01495331","0","5"],["23754.8","0.00717","0","1"],["23754.1","0.00110003","0","1"],["23754","4.58640608","0","3"],["23753.7","2.15617458","0","2"],["23753.6","0.00717","0","1"],["23753.3","0.00034342","0","2"],["23753.1","0.178","0","1"],["23753","0.03303741","0","1"],["23752.7","0.01338674","0","2"],["23752.4","0.00717","0","1"],["23752","0.00001136","0","1"],["23751.2","0.00717","0","1"],["23751","0.00004588","0","2"],["23750.7","3.1295","0","1"],["23750.2","0.0019532","0","2"],["23750","0.03527806","0","23"],["23749.9","0.00019379","0","1"],["23749","0.32708261","0","2"],["23748.8","0.00717","0","1"],["23748.5","0.0023159","0","1"],["23748.3","0.14189486","0","1"],["23747.6","0.00717","0","1"],["23747.2","0.00003241","0","1"],["23747","0.00066334","0","2"],["23746.9","0.00333333","0","1"],["23746.8","0.00026305","0","2"],["23746.6","0.0000151","0","1"],["23746.5","0.00759638","0","2"],["23745.7","0.00022292","0","1"],["23745.4","0.00310231","0","1"],["23745.3","0.00717","0","1"],["23745","0.00072815","0","2"],["23744.8","2.45920195","0","2"],["23744.6","0.00001002","0","1"],["23744.1","0.00717","0","1"],["23744","0.00071235","0","2"],["23743.7","1","0","1"],["23743.1","0.00007171","0","1"],["23742.9","0.00931604","0","2"],["23742.8","0.00045388","0","1"],["23742.4","0.33694887","0","1"],["23742.1","3.97952357","0","2"],["23741.9","0.00112881","0","2"],["23741.8","0.00040905","0","2"],["23741.7","0.00717","0","1"],["23740.9","0.00072072","0","1"],["23740.8","0.00002837","0","1"],["23740.7","0.21003903","0","1"],["23740.5","0.00717","0","1"],["23740","0.01264071","0","2"],["23739.5","0.01046366","0","1"],["23739.3","0.00717","0","1"],["23739.1","0.00047985","0","1"],["23739","0.00048723","0","1"],["23738.9","0.00010736","0","1"],["23738.5","0.00001288","0","1"],["23738.1","0.00776737","0","2"],["23737.5","0.00088179","0","1"],["23737","0.00717","0","1"],["23736.8","0.00002207","0","1"],["23736.1","0.0085723","0","1"],["23736","0.00041942","0","1"],["23735.8","0.00717","0","1"],["23734.6","0.00717","0","1"],["23734.4","0.00025028","0","1"],["23734","0.05048343","0","1"],["23733.4","0.00717","0","1"],["23733.3","0.09428036","0","14"],["23733.2","0.00001153","0","1"],["23732.6","4.57676676","0","3"],["23732.3","2.12156595","0","1"],["23732.2","0.00717","0","1"],["23732","0.00671176","0","3"],["23731.6","0.00001003","0","1"],["23731","0.00741384","0","3"],["23730","0.01106917","0","1"],["23729.8","0.00717","0","1"],["23729.2","0.00024735","0","2"],["23728.7","0.00717","0","1"],["23728.2","0.00015814","0","1"],["23727.7","0.068","0","1"],["23727.5","0.00717","0","1"],["23727.2","0.04545454","0","1"],["23726.9","0.00272771","0","1"],["23726.7","0.00291185","0","1"],["23726.6","0.00002752","0","1"],["23726.3","0.00834337","0","2"],["23725.9","0.00177442","0","1"],["23725.1","0.00717","0","1"],["23725","0.00173507","0","2"],["23724.8","0.00001066","0","1"],["23724.7","0.00012525","0","1"],["23724.1","0.0042589","0","1"],["23723.9","0.00717","0","1"],["23723","0.00046369","0","1"],["23722.7","0.00717","0","1"],["23722.2","0.00001006","0","1"],["23721.6","0.0000112","0","1"],["23721.5","0.00717","0","1"],["23721.1","0.00477637","0","2"],["23721","0.04383487","0","1"],["23720.8","0.00120865","0","2"],["23720.7","1","0","1"],["23720.6","0.00161212","0","1"],["23720.5","0.00001006","0","1"],["23720.4","0.00717","0","1"],["23720.3","0.00028071","0","1"],["23720","0.00093849","0","4"],["23719.9","0.01396986","0","4"],["23719.6","0.00002764","0","1"],["23719.2","0.00717","0","1"],["23718.8","0.00049976","0","1"],["23718.5","0.00025118","0","2"],["23718.4","0.00448285","0","1"],["23718.1","0.00003439","0","1"],["23718","0.00717","0","1"],["23717.9","0.00001086","0","1"],["23717.4","0.00561417","0","1"],["23717.1","0.00001887","0","1"],["23716.8","0.00717","0","1"],["23716.6","0.00262864","0","2"],["23716","0.00001006","0","1"],["23715.6","0.00717","0","1"],["23715","0.00100712","0","1"],["23714.6","0.00001","0","1"],["23714.5","0.03648929","0","6"],["23714.4","0.00720211","0","2"],["23714.2","0.00013124","0","4"],["23714","0.00008714","0","1"],["23713.2","0.00717","0","1"],["23713","0.00086721","0","2"],["23712.5","11.2471","0","1"],["23712.1","0.00717","0","1"],["23712","0.00169258","0","1"],["23711.7","0.00008878","0","1"],["23711.5","0.00009415","0","1"],["23710.9","2.13440994","0","2"],["23710.8","0.00155944","0","1"],["23710.7","0.00076236","0","1"],["23710.1","5.907973","0","2"],["23710","8.05691889","0","3"],["23709.7","0.00717","0","1"],["23709","0.00045128","0","2"],["23708.5","0.01192732","0","2"],["23708.3","0.00099369","0","5"],["23708.2","0.00056256","0","1"],["23708","0.0005662","0","1"],["23707.9","0.00003659","0","1"],["23707.8","0.00006144","0","1"],["23707.3","0.00717","0","1"],["23707.1","0.00077493","0","1"],["23706.3","0.00003139","0","1"],["23706.1","0.00717","0","1"],["23704.9","0.00717","0","1"],["23704.7","0.00027196","0","1"],["23703.8","0.00717","0","1"],["23703.7","0.00337549","0","1"],["23702.6","0.00720261","0","2"],["23702.4","0.00224355","0","1"],["23702.3","0.01338674","0","2"],["23702","0.00144094","0","2"],["23701.8","0.00160421","0","1"],["23701.7","0.00009538","0","1"],["23701.4","0.00960807","0","2"],["23701.2","0.00137104","0","1"],["23700.8","0.00048389","0","1"],["23700.2","0.00717","0","1"],["23700","1.12056997","0","32"],["23699.9","0.00025542","0","2"],["23699.2","0.00084269","0","2"],["23699","0.00717","0","1"],["23698.6","0.0001002","0","1"],["23698.1","4.138","0","1"],["23698","0.00041909","0","1"],["23697.8","0.00717","0","1"],["23697.6","0.00029481","0","2"],["23697","0.0000169","0","1"],["23696.6","0.00717","0","1"],["23696.4","0.00001049","0","1"],["23695.7","0.0023159","0","1"],["23695.6","0.0023435","0","2"],["23695.5","0.00717","0","1"],["23694.7","0.00025118","0","2"],["23694.3","0.00717","0","1"],["23693.1","0.00746241","0","2"],["23692.4","0.00002837","0","1"],["23692.3","0.00005739","0","1"],["23691.9","0.00717","0","1"],["23690.7","0.00717","0","1"],["23690.4","0.00026755","0","1"],["23690","0.00133372","0","2"],["23689.9","0.00148821","0","1"],["23689.5","0.00717","0","1"],["23689.3","0.02151049","0","2"],["23689","0.001","0","1"],["23688.8","0.00003499","0","1"],["23688.5","0.00005134","0","1"],["23688.4","0.00717","0","1"],["23687.5","0.00002844","0","1"],["23687.2","0.00717","0","1"],["23686.8","0.00042792","0","1"],["23686.3","0.00062998","0","1"],["23686","0.00730639","0","3"],["23685.7","0.0020578","0","2"],["23685.3","0.00179175","0","3"],["23685","0.00100621","0","1"],["23684.8","0.00717","0","1"],["23684.2","0.00003209","0","2"],["23683.6","0.00717","0","1"],["23683.3","0.00006397","0","1"],["23683.2","0.00001237","0","1"],["23682.4","0.00717","0","1"],["23682","0.1","0","1"],["23681.8","0.00093078","0","1"]],"ts":"1659032075478","checksum":-1411668973}]}
    #[test]
    fn should_parse_an_update() {
        // Given
        let msg = r#"{"arg":{"channel":"books","instId":"BTC-USDT"},"action":"update","data":[{"asks":[["23811.9","0.23617","0","2"],["23812.7","0.23476097","0","2"],["23812.9","0","0","0"],["23813.1","1.10776842","0","4"],["23814","0.06819","0","1"],["23815.2","0.06819","0","1"],["23817.1","0","0","0"],["23817.6","0.41981509","0","1"],["23819.5","0.15","0","1"],["23844.3","0","0","0"],["23983.9","0","0","0"]],"bids":[["23810.9","0.036","0","1"],["23809.3","0","0","0"],["23807.8","0","0","0"],["23805.6","0","0","0"],["23804.4","0.06819","0","1"],["23798","0","0","0"],["23777.6","0","0","0"],["23710","5.03337938","0","2"],["23681.6","0.00003267","0","1"],["23681.2","0.00720545","0","2"],["23680.4","0.00001458","0","1"],["23680.1","0.00717","0","1"]],"ts":"1659032075508","checksum":-1045516107}]}"#;

        // When
        let resp: WebsocketResponse = serde_json::from_str(msg).unwrap();

        // Then
        if let WebsocketResponse::Action(orderbook_response) = resp {
            if let OrderbookResponse::Update { data } = orderbook_response {
                assert_eq!(1, data.len());

                assert_eq!(11, data[0].asks.len());
                assert_eq!(12, data[0].bids.len());
            } else {
                assert!(false, "not an update");
            }
        } else {
            assert!(false, "not an action");
        }
    }
}
